<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>豆包AI语音通话 - 浏览器版</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1000px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            grid-template-areas: 
                "header header"
                "connection voice"
                "message message"
                "log log";
        }

        .app-header {
            grid-area: header;
            text-align: center;
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .connection-section {
            grid-area: connection;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .config-group {
            margin-bottom: 15px;
        }

        .config-label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .config-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .config-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-indicator {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            margin: 15px 0;
            transition: all 0.3s;
        }

        .status-disconnected {
            background: #fee;
            color: #c33;
            border: 2px solid #fcc;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
        }

        .voice-section {
            grid-area: voice;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .voice-button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin: 0 auto;
        }

        .voice-button-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .volume-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 100px;
            z-index: 1;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 2;
        }

        .volume-text {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .voice-button.recording {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-button.idle {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }

        .voice-button:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }


        .message-section {
            grid-area: message;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .message-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }

        .conversation-display {
            background: white;
            border-radius: 10px;
            padding: 15px;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: #e9ecef;
            color: #333;
        }

        .message-time {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .log-section {
            grid-area: log;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .log-display {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            height: 180px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
        }

        .log-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .floating-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s;
        }

        .floating-indicator.hidden {
            opacity: 0;
            transform: translateY(-20px);
        }

        .config-status {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: normal;
            margin-left: 10px;
        }

        .config-status.saved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .config-status.unsaved {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .audio-device-section {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .device-row {
            margin-bottom: 15px;
        }

        .device-row:last-child {
            margin-bottom: 0;
        }

        .device-two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .device-combo {
            display: flex;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: border-color 0.3s;
        }

        .device-combo:focus-within {
            border-color: #667eea;
        }

        .device-select-combo {
            flex: 1;
            padding: 8px 12px;
            border: none;
            font-size: 14px;
            background: transparent;
            cursor: pointer;
            outline: none;
        }

        .device-select-combo:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .btn-combo {
            padding: 8px 12px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            border-left: 1px solid #e9ecef;
        }

        .btn-combo:hover:not(:disabled) {
            opacity: 0.8;
        }

        .btn-combo:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-combo.btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-combo.btn-success {
            background: #51cf66;
            color: white;
        }

        .device-row-inline {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .device-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-group-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .device-label {
            min-width: 100px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .device-label-inline {
            font-size: 16px;
            min-width: 20px;
        }

        .device-select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .device-select-inline {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 150px;
        }

        .device-actions {
            display: flex;
            gap: 8px;
        }

        .device-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .device-select:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
        }

        .btn-small:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .audio-volume-control {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid #e9ecef;
        }

        .volume-label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .volume-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .app-container {
                width: 95%;
                padding: 15px;
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "connection"
                    "voice"
                    "message"
                    "log";
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                min-width: auto;
            }

            .voice-button {
                width: 70px;
                height: 70px;
                font-size: 1.8em;
            }

            .volume-text {
                font-size: 11px;
            }

            .device-two-column {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .device-row-inline {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .device-group-inline {
                min-width: auto;
            }

            .device-actions {
                justify-content: center;
            }

            .device-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .device-label {
                min-width: auto;
                font-size: 13px;
            }

            .audio-device-section {
                padding: 12px;
            }

            .log-display {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1 class="app-title">🤖 豆包AI语音通话</h1>
            <p class="app-subtitle">高质量实时语音对话体验</p>
        </div>

        <!-- 连接配置 -->
        <div class="connection-section">
            <h3 class="section-title">🔧 连接配置 <span id="configStatus" class="config-status"></span></h3>
            
            <div class="config-group">
                <label class="config-label">代理服务器地址</label>
                <input type="text" id="proxyUrl" class="config-input" value="ws://localhost:8765" placeholder="ws://localhost:8765">
            </div>
            
            <div class="config-group">
                <label class="config-label">App ID</label>
                <input type="text" id="appId" class="config-input" placeholder="请输入火山引擎App ID">
            </div>
            
            <div class="config-group">
                <label class="config-label">Access Token</label>
                <input type="password" id="accessToken" class="config-input" placeholder="请输入火山引擎Access Token">
            </div>

            <div class="button-group">
                <button id="connectionToggleBtn" class="btn btn-primary" onclick="toggleConnection()">连接</button>
            </div>
        </div>

        <!-- 语音控制 -->
        <div class="voice-section">
            <h3 class="section-title">🎤 语音对话</h3>
            
            <!-- 音频设备选择 -->
            <div class="audio-device-section">
                <div class="device-two-column">
                    <div class="device-combo">
                        <select id="microphoneSelect" class="device-select-combo">
                            <option value="">🎤 选择麦克风...</option>
                        </select>
                        <button class="btn-combo btn-primary" onclick="refreshAudioDevices()" title="刷新设备列表">🔄</button>
                    </div>
                    <div class="device-combo">
                        <select id="speakerSelect" class="device-select-combo">
                            <option value="">🔊 选择扬声器...</option>
                        </select>
                        <button class="btn-combo btn-success" onclick="testSpeaker()" title="测试扬声器">🔔</button>
                    </div>
                </div>
            </div>
            
            <div class="voice-controls">
                <div class="voice-button-container">
                    <div class="voice-button-wrapper">
                        <svg class="volume-ring" width="100" height="100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e9ecef" stroke-width="4"></circle>
                            <circle id="volumeRing" cx="50" cy="50" r="45" fill="none" stroke="#51cf66" stroke-width="4" 
                                    stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="283" 
                                    transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 0.1s ease;"></circle>
                        </svg>
                        <button id="voiceButton" class="voice-button idle" onclick="toggleRecording()" disabled>
                            🎤
                        </button>
                    </div>
                    <span id="volumeText" class="volume-text">0%</span>
                </div>
                
                <div class="audio-volume-control">
                    <label class="volume-label">🔊 AI语音音量: <span id="aiVolumeText">30%</span></label>
                    <input type="range" id="aiVolumeSlider" class="volume-slider" 
                           min="0" max="100" value="30" 
                           title="调节AI语音播放音量">
                </div>
            </div>
        </div>

        <!-- 文本消息 -->
        <div class="message-section">
            <h3 class="section-title">💬 对话记录</h3>
            
            <div class="message-input-group">
                <input type="text" id="messageInput" class="message-input" placeholder="输入文本消息..." value="仰天大笑出门去">
                <button class="btn btn-primary" onclick="sendMessage()">发送</button>
            </div>
            
            <div id="conversationDisplay" class="conversation-display"></div>
        </div>

        <!-- 日志 -->
        <div class="log-section">
            <h3 class="section-title">📋 系统日志</h3>
            <div id="logDisplay" class="log-display"></div>
            <div class="log-controls">
                <button class="btn btn-primary" onclick="clearLog()">清空日志</button>
                <button class="btn btn-primary" onclick="copyLog()">📋 复制日志</button>
                <button class="btn btn-primary" onclick="toggleAutoScroll()">
                    <span id="autoScrollText">自动滚动: 开</span>
                </button>
            </div>
        </div>
    </div>

    <div id="floatingIndicator" class="floating-indicator hidden"></div>

    <script>
        class VoiceChat {
            constructor() {
                this.websocket = null;
                this.mediaStream = null;
                this.audioContext = null;
                this.processor = null; 
                this.isRecording = false;
                this.isConnected = false;
                this.autoScroll = true;
                this.volumeAnalyser = null;
                this.volumeDataArray = null;
                this.microphonePermission = null; // 麦克风权限状态
                
                // 流式音频播放
                this.audioStream = null;
                this.audioBuffers = [];
                this.currentPlayTime = 0;
                this.currentAudioSources = []; // 跟踪正在播放的音频源
                
                // 扬声器切换支持
                this.audioElement = null;
                this.mediaStreamDestination = null;
                
                // 配置存储键名
                this.storageKeys = {
                    proxyUrl: 'voiceChat_proxyUrl',
                    appId: 'voiceChat_appId',
                    accessToken: 'voiceChat_accessToken',
                    autoScroll: 'voiceChat_autoScroll',
                    selectedMicrophone: 'voiceChat_selectedMicrophone',
                    selectedSpeaker: 'voiceChat_selectedSpeaker',
                    aiVolume: 'voiceChat_aiVolume'
                };
                
                // 音频设备相关
                this.audioDevices = {
                    microphones: [],
                    speakers: []
                };
                this.selectedMicrophoneId = null;
                this.selectedSpeakerId = null;
                this.aiVolume = 0.3; // 默认30%音量
                
                this.initializeUI();
                this.loadConfiguration();
                this.bindEvents();
            }

            async initializeUI() {
                this.updateUI();
                await this.loadAudioDevices();
                this.log('🚀 豆包AI语音通话系统已加载', 'info');
            }

            loadConfiguration() {
                // 加载保存的配置
                try {
                    const proxyUrl = localStorage.getItem(this.storageKeys.proxyUrl);
                    const appId = localStorage.getItem(this.storageKeys.appId);
                    const accessToken = localStorage.getItem(this.storageKeys.accessToken);
                    const autoScroll = localStorage.getItem(this.storageKeys.autoScroll);
                    
                    let hasConfig = false;
                    
                    if (proxyUrl) {
                        document.getElementById('proxyUrl').value = proxyUrl;
                        hasConfig = true;
                    }
                    if (appId) {
                        document.getElementById('appId').value = appId;
                        hasConfig = true;
                    }
                    if (accessToken) {
                        document.getElementById('accessToken').value = accessToken;
                        hasConfig = true;
                    }
                    if (autoScroll !== null) {
                        this.autoScroll = autoScroll === 'true';
                        document.getElementById('autoScrollText').textContent = 
                            `自动滚动: ${this.autoScroll ? '开' : '关'}`;
                        hasConfig = true;
                    }
                    
                    // 加载音频设备选择
                    const selectedMicrophone = localStorage.getItem(this.storageKeys.selectedMicrophone);
                    const selectedSpeaker = localStorage.getItem(this.storageKeys.selectedSpeaker);
                    
                    if (selectedMicrophone) {
                        this.selectedMicrophoneId = selectedMicrophone;
                        hasConfig = true;
                    }
                    if (selectedSpeaker) {
                        this.selectedSpeakerId = selectedSpeaker;
                        hasConfig = true;
                    }
                    
                    // 加载AI音量设置
                    const aiVolume = localStorage.getItem(this.storageKeys.aiVolume);
                    if (aiVolume !== null) {
                        this.aiVolume = parseFloat(aiVolume);
                        document.getElementById('aiVolumeSlider').value = this.aiVolume * 100;
                        document.getElementById('aiVolumeText').textContent = `${Math.round(this.aiVolume * 100)}%`;
                        hasConfig = true;
                    }
                    
                    this.updateConfigStatus(hasConfig);
                    
                    if (hasConfig) {
                        this.log('📥 已加载保存的配置', 'info');
                    }
                } catch (error) {
                    this.log('⚠️ 加载配置失败: ' + error.message, 'warning');
                    this.updateConfigStatus(false);
                }
            }

            saveConfiguration() {
                // 保存当前配置
                try {
                    const proxyUrl = document.getElementById('proxyUrl').value;
                    const appId = document.getElementById('appId').value;
                    const accessToken = document.getElementById('accessToken').value;
                    
                    if (proxyUrl) {
                        localStorage.setItem(this.storageKeys.proxyUrl, proxyUrl);
                    }
                    if (appId) {
                        localStorage.setItem(this.storageKeys.appId, appId);
                    }
                    if (accessToken) {
                        localStorage.setItem(this.storageKeys.accessToken, accessToken);
                    }
                    localStorage.setItem(this.storageKeys.autoScroll, this.autoScroll.toString());
                    
                    // 保存音频设备选择
                    if (this.selectedMicrophoneId) {
                        localStorage.setItem(this.storageKeys.selectedMicrophone, this.selectedMicrophoneId);
                    }
                    if (this.selectedSpeakerId) {
                        localStorage.setItem(this.storageKeys.selectedSpeaker, this.selectedSpeakerId);
                    }
                    
                    // 保存AI音量设置
                    localStorage.setItem(this.storageKeys.aiVolume, this.aiVolume.toString());
                    
                    this.updateConfigStatus(true);
                    this.log('💾 配置已保存', 'success');
                } catch (error) {
                    this.log('❌ 保存配置失败: ' + error.message, 'error');
                    this.updateConfigStatus(false);
                }
            }

            clearConfiguration() {
                // 清除保存的配置
                try {
                    Object.values(this.storageKeys).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // 重置表单
                    document.getElementById('proxyUrl').value = 'ws://localhost:8765';
                    document.getElementById('appId').value = '';
                    document.getElementById('accessToken').value = '';
                    
                    this.updateConfigStatus(false);
                    this.log('🗑️ 配置已清除', 'info');
                } catch (error) {
                    this.log('❌ 清除配置失败: ' + error.message, 'error');
                }
            }

            updateConfigStatus(hasSavedConfig) {
                // 更新配置状态指示器
                const statusElement = document.getElementById('configStatus');
                if (hasSavedConfig) {
                    statusElement.className = 'config-status saved';
                    statusElement.textContent = '✅ 已保存';
                    statusElement.title = '配置已保存到本地存储';
                } else {
                    statusElement.className = 'config-status unsaved';
                    statusElement.textContent = '⚠️ 未保存';
                    statusElement.title = '配置尚未保存';
                }
            }

            async loadAudioDevices() {
                // 加载音频设备列表
                try {
                    // 先请求麦克风权限以获取设备标签
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        stream.getTracks().forEach(track => track.stop()); // 立即停止流
                        this.log('🎤 麦克风权限已获取', 'success');
                    } catch (permissionError) {
                        this.log(`⚠️ 麦克风权限请求失败: ${permissionError.message}`, 'warning');
                        this.log('📝 设备标签可能无法正常显示', 'info');
                    }
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    
                    this.audioDevices.microphones = devices.filter(device => 
                        device.kind === 'audioinput' && device.deviceId !== 'default'
                    );
                    this.audioDevices.speakers = devices.filter(device => 
                        device.kind === 'audiooutput' && device.deviceId !== 'default'
                    );
                    
                    this.updateDeviceSelectors();
                    this.log(`🎧 检测到 ${this.audioDevices.microphones.length} 个麦克风，${this.audioDevices.speakers.length} 个扬声器`, 'info');
                    
                } catch (error) {
                    this.log(`❌ 加载音频设备失败: ${error.message}`, 'error');
                    // 即使失败也要初始化选择器
                    this.updateDeviceSelectors();
                }
            }

            updateDeviceSelectors() {
                // 更新设备选择器
                const micSelect = document.getElementById('microphoneSelect');
                const speakerSelect = document.getElementById('speakerSelect');
                
                // 清空现有选项
                micSelect.innerHTML = '<option value="">选择麦克风...</option>';
                speakerSelect.innerHTML = '<option value="">选择扬声器...</option>';
                
                // 添加麦克风选项
                this.audioDevices.microphones.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `麦克风 ${device.deviceId.substring(0, 8)}...`;
                    if (device.deviceId === this.selectedMicrophoneId) {
                        option.selected = true;
                    }
                    micSelect.appendChild(option);
                });
                
                // 添加扬声器选项
                this.audioDevices.speakers.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `扬声器 ${device.deviceId.substring(0, 8)}...`;
                    if (device.deviceId === this.selectedSpeakerId) {
                        option.selected = true;
                    }
                    speakerSelect.appendChild(option);
                });
                
                // 如果没有选中的设备，自动选择第一个
                if (!this.selectedMicrophoneId && this.audioDevices.microphones.length > 0) {
                    this.selectedMicrophoneId = this.audioDevices.microphones[0].deviceId;
                    micSelect.value = this.selectedMicrophoneId;
                }
                
                if (!this.selectedSpeakerId && this.audioDevices.speakers.length > 0) {
                    this.selectedSpeakerId = this.audioDevices.speakers[0].deviceId;
                    speakerSelect.value = this.selectedSpeakerId;
                }
            }

            async refreshAudioDevices() {
                // 刷新音频设备列表
                this.log('🔄 正在刷新音频设备列表...', 'info');
                
                try {
                    // 请求权限以获取设备标签
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    await this.loadAudioDevices();
                    this.log('✅ 音频设备列表已刷新', 'success');
                } catch (error) {
                    this.log(`❌ 刷新设备列表失败: ${error.message}`, 'error');
                }
            }

            onMicrophoneChange() {
                // 麦克风选择变化
                const micSelect = document.getElementById('microphoneSelect');
                this.selectedMicrophoneId = micSelect.value;
                
                if (this.selectedMicrophoneId) {
                    const device = this.audioDevices.microphones.find(d => d.deviceId === this.selectedMicrophoneId);
                    const deviceName = device ? (device.label || '未知设备') : '未知设备';
                    this.log(`🎤 已选择麦克风: ${deviceName}`, 'info');
                    this.saveConfiguration();
                }
            }

            onSpeakerChange() {
                // 扬声器选择变化
                const speakerSelect = document.getElementById('speakerSelect');
                this.selectedSpeakerId = speakerSelect.value;
                
                if (this.selectedSpeakerId) {
                    const device = this.audioDevices.speakers.find(d => d.deviceId === this.selectedSpeakerId);
                    const deviceName = device ? (device.label || '未知设备') : '未知设备';
                    this.log(`🔊 已选择扬声器: ${deviceName}`, 'info');
                    this.saveConfiguration();
                }
            }

            async testSpeaker() {
                // 测试扬声器
                if (!this.selectedSpeakerId) {
                    this.log('⚠️ 请先选择扬声器设备', 'warning');
                    return;
                }

                try {
                    this.log('🔔 正在测试扬声器...', 'info');
                    
                    // 创建测试音频上下文
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // 创建1秒的测试音调 (440Hz)
                    const duration = 0.5;
                    const sampleRate = audioContext.sampleRate;
                    const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
                    const channelData = buffer.getChannelData(0);
                    
                    for (let i = 0; i < channelData.length; i++) {
                        channelData[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 0.3;
                    }
                    
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    
                    // 如果支持，设置输出设备
                    if (audioContext.destination.setSinkId) {
                        await audioContext.destination.setSinkId(this.selectedSpeakerId);
                    }
                    
                    source.start();
                    
                    this.log('✅ 扬声器测试完成', 'success');
                    
                } catch (error) {
                    this.log(`❌ 扬声器测试失败: ${error.message}`, 'error');
                }
            }

            onAIVolumeChange(value) {
                // AI音量变化处理
                this.aiVolume = parseFloat(value) / 100;
                document.getElementById('aiVolumeText').textContent = `${value}%`;
                
                this.log(`🔊 AI语音音量调节为: ${value}%`, 'info');
                
                // 延迟保存，避免频繁操作
                clearTimeout(this.volumeTimeout);
                this.volumeTimeout = setTimeout(() => {
                    this.saveConfiguration();
                }, 500);
            }

            bindEvents() {
                // 回车发送消息
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // 配置字段变化时自动保存
                const configInputs = ['proxyUrl', 'appId', 'accessToken'];
                configInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    input.addEventListener('blur', () => {
                        this.saveConfiguration();
                    });
                    input.addEventListener('input', () => {
                        // 延迟保存，避免频繁操作
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(() => {
                            this.saveConfiguration();
                        }, 1000);
                    });
                });

                // 音频设备选择器事件
                document.getElementById('microphoneSelect').addEventListener('change', () => {
                    this.onMicrophoneChange();
                });
                
                document.getElementById('speakerSelect').addEventListener('change', () => {
                    this.onSpeakerChange();
                });

                // AI音量滑块事件
                document.getElementById('aiVolumeSlider').addEventListener('input', (e) => {
                    this.onAIVolumeChange(e.target.value);
                });

                // 页面卸载前保存配置
                window.addEventListener('beforeunload', () => {
                    this.saveConfiguration();
                    this.disconnect();
                });

                // 定期心跳
                setInterval(() => {
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.websocket.send(JSON.stringify({type: 'ping'}));
                    }
                }, 30000);
            }

            log(message, type = 'info') {
                const logElement = document.getElementById('logDisplay');
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}\n`;
                
                logElement.textContent += logMessage;
                
                if (this.autoScroll) {
                    logElement.scrollTop = logElement.scrollHeight;
                }
                
                console.log(`[${type.toUpperCase()}] ${message}`);
                
                // 显示浮动指示器
                this.showFloatingIndicator(message, type);
            }

            showFloatingIndicator(message, type) {
                const indicator = document.getElementById('floatingIndicator');
                const colors = {
                    'info': '#17a2b8',
                    'success': '#28a745',
                    'warning': '#ffc107',
                    'error': '#dc3545'
                };
                
                indicator.style.background = colors[type] || colors.info;
                indicator.textContent = message;
                indicator.classList.remove('hidden');
                
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 3000);
            }

            clearLog() {
                document.getElementById('logDisplay').textContent = '';
                this.log('日志已清空', 'info');
            }

            async copyLog() {
                try {
                    const logDisplay = document.getElementById('logDisplay');
                    
                    // 直接获取日志显示区域的文本内容
                    const logText = logDisplay.textContent || '';
                    
                    if (!logText.trim()) {
                        alert('没有日志内容可复制');
                        return;
                    }
                    
                    // 添加头部信息
                    const header = `豆包AI语音通话系统 - 日志导出\n时间: ${new Date().toLocaleString()}\n${'='.repeat(50)}\n\n`;
                    const fullLogText = header + logText;
                    
                    // 使用Clipboard API复制到剪贴板
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(fullLogText);
                        this.log('📋 日志已复制到剪贴板', 'success');
                    } else {
                        // 回退方案：使用传统方法
                        const textArea = document.createElement('textarea');
                        textArea.value = fullLogText;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            this.log('📋 日志已复制到剪贴板', 'success');
                        } catch (err) {
                            this.log('❌ 复制失败，请手动选择日志文本', 'error');
                        }
                        
                        document.body.removeChild(textArea);
                    }
                    
                } catch (error) {
                    this.log(`❌ 复制日志失败: ${error.message}`, 'error');
                }
            }

            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                document.getElementById('autoScrollText').textContent = 
                    `自动滚动: ${this.autoScroll ? '开' : '关'}`;
                this.log(`自动滚动已${this.autoScroll ? '启用' : '禁用'}`, 'info');
                // 保存自动滚动设置
                this.saveConfiguration();
            }

            async updateUI() {
                const connectionBtn = document.getElementById('connectionToggleBtn');
                if (this.isConnected) {
                    connectionBtn.textContent = '断开连接';
                    connectionBtn.className = 'btn btn-danger';
                } else {
                    connectionBtn.textContent = '连接';
                    connectionBtn.className = 'btn btn-primary';
                }
                
                // 检查麦克风权限状态
                await this.checkMicrophonePermission();
                
                // 录音按钮启用条件：仅需要麦克风权限，不依赖连接状态
                const canRecord = this.microphonePermission !== 'denied';
                console.log(`录音状态：`, {isConnected: this.isConnected, microphonePermission: this.microphonePermission, canRecord})
                document.getElementById('voiceButton').disabled = !canRecord;
                
                // 音频设备功能完全独立于连接状态
                // - 录音：可以离线测试麦克风
                // - 刷新设备：始终可用
                // - 扬声器测试：仅需要选择了设备
                
                const voiceButton = document.getElementById('voiceButton');
                if (this.isRecording) {
                    voiceButton.className = 'voice-button recording';
                    voiceButton.textContent = '🛑';
                } else {
                    voiceButton.className = 'voice-button idle';
                    voiceButton.textContent = '🎤';
                }
                
                // 显示权限状态提示（不依赖连接状态）
                if (!canRecord) {
                    if (this.microphonePermission === 'denied') {
                        this.log('⚠️ 麦克风权限被拒绝，无法使用录音功能', 'warning');
                    }
                } else if (this.microphonePermission === 'prompt') {
                    this.log('📝 点击录音按钮时将请求麦克风权限', 'info');
                }
            }

            async checkMicrophonePermission() {
                // 检查麦克风权限状态
                try {
                    if (navigator.permissions) {
                        const permission = await navigator.permissions.query({ name: 'microphone' });
                        this.microphonePermission = permission.state;
                        
                        // 监听权限变化
                        permission.onchange = () => {
                            this.microphonePermission = permission.state;
                            this.updateUI();
                        };
                    } else {
                        // 对于不支持permissions API的浏览器，假设需要用户授权
                        this.microphonePermission = 'prompt';
                    }
                } catch (error) {
                    this.log(`⚠️ 无法检查麦克风权限: ${error.message}`, 'warning');
                    this.microphonePermission = 'prompt';
                }
            }

            updateConnectionStatus(status, message) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = message;
            }

            async connect() {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const appId = document.getElementById('appId').value;
                const accessToken = document.getElementById('accessToken').value;

                if (!appId || !accessToken) {
                    alert('请填写App ID和Access Token');
                    return;
                }

                try {
                    this.updateConnectionStatus('connecting', '🟡 连接中...');
                    this.log('🔄 开始连接代理服务器...', 'info');

                    this.websocket = new WebSocket(proxyUrl);

                    this.websocket.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus('connected', '🟢 已连接');
                        this.updateUI();
                        this.initAudioStream(); // 初始化音频流
                    };

                    this.websocket.binaryType = 'arraybuffer'; // 强制使用ArrayBuffer
                    
                    this.websocket.onmessage = (event) => {
                        try {
                            if (event.data instanceof ArrayBuffer) {
                                // 直接处理二进制音频数据
                                this.handleAudioBinary(event.data);
                            } else if (event.data instanceof Blob) {
                                // 转换Blob为ArrayBuffer
                                event.data.arrayBuffer().then(buffer => {
                                    this.handleAudioBinary(buffer);
                                });
                            } else {
                                // 处理JSON消息
                                const data = JSON.parse(event.data);
                                this.handleMessage(data);
                            }
                        } catch (e) {
                            this.log(`❌ 处理消息失败: ${e.message}`, 'error');
                        }
                    };

                    this.websocket.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus('disconnected', '🔴 连接断开');
                        this.log('🔌 WebSocket连接已断开', 'warning');
                        this.updateUI();
                    };

                    this.websocket.onerror = (error) => {
                        this.log(`❌ WebSocket错误: ${error}`, 'error');
                        this.updateConnectionStatus('disconnected', '🔴 连接错误');
                        this.updateUI();
                    };

                } catch (error) {
                    this.log(`❌ 连接失败: ${error.message}`, 'error');
                    this.updateConnectionStatus('disconnected', '🔴 连接失败');
                    this.updateUI();
                }
            }

            handleMessage(data) {
                switch (data.type) {
                    
                    case 'event':
                        this.handleServerEvent(data.event, data.data);
                        break;
                    
                    case 'error':
                        this.log(`❌ 服务器错误: ${data.message}`, 'error');
                        break;
                    
                    case 'pong':
                        this.log('💓 收到心跳回复', 'info');
                        break;
                    
                    default:
                        this.log(`❓ 未知消息类型: ${data.type}`, 'warning');
                }
            }

            handleServerEvent(event, data) {
                // 处理服务器事件，包括语音打断逻辑
                this.log(`📢 收到事件: ${event} - ${JSON.stringify(data)}`, 'info');
                
                // ASR_INFO事件：用户开始说话，需要打断AI语音
                if (event === 450) { // protocol.ServerEvent.ASR_INFO
                    this.log('🛑 检测到用户语音，打断AI播放', 'warning');
                    this.interruptAIAudio();
                }
            }

            handleAudioBinary(arrayBuffer) {
                // 直接处理二进制音频数据
                try {
                    this.streamAudioData(arrayBuffer);
                    this.addMessage('AI', '🔊 [语音回复]', true);
                } catch (error) {
                    this.log(`❌ 处理音频数据失败: ${error.message}`, 'error');
                }
            }

            disconnect() {
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
                
                if (this.isRecording) {
                    this.stopRecording();
                }
                
                // 清理音频流
                this.audioBuffers = [];
                this.currentPlayTime = 0;
                this.interruptAIAudio(); // 停止所有正在播放的音频
                if (this.audioStream) {
                    this.audioStream.disconnect();
                    this.audioStream = null;
                }
                
                // 清理音频元素
                if (this.audioElement) {
                    this.audioElement.pause();
                    this.audioElement.srcObject = null;
                    if (this.audioElement.parentNode) {
                        this.audioElement.parentNode.removeChild(this.audioElement);
                    }
                    this.audioElement = null;
                }
                this.mediaStreamDestination = null;
                
                this.isConnected = false;
                this.updateConnectionStatus('disconnected', '🔴 未连接');
                this.updateUI();
                this.log('🔌 已断开连接，音频队列已清理', 'info');
            }

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                try {
                    this.log('🎤 请求麦克风权限...', 'info');
                    
                    // 构建音频约束，包括设备ID
                    const audioConstraints = {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    };
                    
                    // 如果选择了特定麦克风，添加设备ID约束
                    if (this.selectedMicrophoneId) {
                        // 使用ideal而不是exact，提供更好的兼容性
                        audioConstraints.deviceId = { ideal: this.selectedMicrophoneId };
                        
                        const device = this.audioDevices.microphones.find(d => d.deviceId === this.selectedMicrophoneId);
                        const deviceName = device ? (device.label || '未知设备') : '选定设备';
                        this.log(`🎤 尝试使用麦克风: ${deviceName}`, 'info');
                    } else {
                        // 没有选择特定设备时，使用默认设备
                        this.log(`🎤 使用默认麦克风设备`, 'info');
                    }
                    
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: audioConstraints
                    });

                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });

                    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                    
                    // 创建音频处理节点
                    this.processor = this.audioContext.createScriptProcessor(4096, 1, 1);
                    
                    // 创建音量分析器
                    this.volumeAnalyser = this.audioContext.createAnalyser();
                    this.volumeAnalyser.fftSize = 256;
                    this.volumeDataArray = new Uint8Array(this.volumeAnalyser.frequencyBinCount);
                    
                    source.connect(this.volumeAnalyser);
                    source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);

                    // 音频数据处理
                    this.processor.onaudioprocess = (event) => {
                        if (!this.isRecording) {
                            return;
                        }

                        const inputBuffer = event.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        
                        // 如果已连接服务器，发送音频数据
                        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                            // 转换为16位PCM
                            const pcmData = new Int16Array(inputData.length);
                            for (let i = 0; i < inputData.length; i++) {
                                pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                            }

                            // 发送音频数据
                            const message = {
                                type: 'audio',
                                data: Array.from(new Uint8Array(pcmData.buffer))
                                    .map(byte => byte.toString(16).padStart(2, '0'))
                                    .join('')
                            };
                            this.websocket.send(JSON.stringify(message));
                        }
                        // 如果未连接，录音仍然工作（用于测试麦克风）
                    };

                    this.isRecording = true;
                    this.updateUI();
                    this.startVolumeMonitoring();
                    if (this.isConnected) {
                        this.log('🎙️ 开始录音并发送到服务器', 'success');
                        this.addMessage('User', '🎤 [开始语音输入]');
                    } else {
                        this.log('🎙️ 开始录音测试（离线模式）', 'success');
                    }

                } catch (error) {
                    this.log(`❌ 启动录音失败: ${error.message}`, 'error');
                }
            }

            stopRecording() {
                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                    this.mediaStream = null;
                }

                this.isRecording = false;
                this.updateUI();
                
                // 重置音量显示
                const volumeRing = document.getElementById('volumeRing');
                const volumeText = document.getElementById('volumeText');
                if (volumeRing) {
                    volumeRing.style.strokeDashoffset = '283';
                    volumeRing.style.stroke = '#51cf66';
                }
                if (volumeText) {
                    volumeText.textContent = '0%';
                }
                
                if (this.isConnected) {
                    this.log('🛑 停止录音', 'info');
                    this.addMessage('User', '🎤 [语音输入结束]');
                } else {
                    this.log('🛑 停止录音测试', 'info');
                }
            }

            startVolumeMonitoring() {
                const updateVolume = () => {
                    try {
                        if (!this.isRecording || !this.volumeAnalyser || !this.volumeDataArray) {
                            return;
                        }
                        
                        // 检查音频上下文状态
                        if (this.audioContext && this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                        
                        this.volumeAnalyser.getByteFrequencyData(this.volumeDataArray);
                        
                        // 计算音量平均值和峰值
                        const average = this.volumeDataArray.reduce((sum, value) => sum + value, 0) / this.volumeDataArray.length;
                        const peak = Math.max(...this.volumeDataArray);
                        
                        // 使用峰值和平均值的组合来提高敏感度
                        const volumeLevel = Math.max(average, peak * 0.3);
                        const percentage = Math.round((volumeLevel / 255) * 100);
                        
                        // 更新音量环和文字
                        const volumeRing = document.getElementById('volumeRing');
                        const volumeText = document.getElementById('volumeText');
                        
                        if (volumeRing && volumeText) {
                            // 计算环形进度（周长 283 = 2 * PI * 45）
                            const circumference = 283;
                            const offset = circumference - (circumference * percentage / 100);
                            volumeRing.style.strokeDashoffset = offset;
                            
                            // 根据音量水平调整颜色
                            if (percentage < 30) {
                                volumeRing.style.stroke = '#51cf66'; // 绿色
                            } else if (percentage < 70) {
                                volumeRing.style.stroke = '#ffd43b'; // 黄色
                            } else {
                                volumeRing.style.stroke = '#ff6b6b'; // 红色
                            }
                            
                            volumeText.textContent = `${percentage}%`;
                        }
                        
                        // 如果录音中，继续监控
                        if (this.isRecording) {
                            requestAnimationFrame(updateVolume);
                        }
                        
                    } catch (error) {
                        this.log(`⚠️ 音量监控异常: ${error.message}`, 'warning');
                        // 异常时停止监控，避免无限循环错误
                        return;
                    }
                };
                updateVolume();
            }

            initAudioStream() {
                // 初始化流式音频播放系统
                try {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    this.log('🎵 音频流系统已初始化', 'info');
                } catch (error) {
                    this.log(`❌ 初始化音频流失败: ${error.message}`, 'error');
                }
            }

            streamAudioData(arrayBuffer) {
                // 流式处理音频数据
                try {
                    if (!this.audioContext) {
                        this.initAudioStream();
                    }
                    
                    // 确保AudioContext已启动
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    // 火山引擎返回24kHz Float32 PCM数据
                    const sampleRate = 24000;
                    let samples;
                    
                    // 检查数据长度是否为4的倍数（Float32）
                    if (arrayBuffer.byteLength % 4 === 0) {
                        samples = new Float32Array(arrayBuffer);
                        this.log(`🔊 接收Float32音频流: ${arrayBuffer.byteLength}字节 → ${samples.length}采样点`, 'info');
                    } else {
                        // 处理不规则长度，截断到4字节边界
                        const validLength = Math.floor(arrayBuffer.byteLength / 4) * 4;
                        if (validLength < 4) {
                            this.log(`⚠️ 音频数据过短: ${arrayBuffer.byteLength}字节，跳过播放`, 'warning');
                            return;
                        }
                        
                        const validBuffer = arrayBuffer.slice(0, validLength);
                        samples = new Float32Array(validBuffer);
                        this.log(`⚠️ 音频数据长度异常: ${arrayBuffer.byteLength}字节，截断为${validLength}字节处理`, 'warning');
                    }
                    
                    // 检查音频数据范围
                    const maxValue = Math.max(...samples);
                    const minValue = Math.min(...samples);
                    const avgValue = samples.reduce((sum, val) => sum + Math.abs(val), 0) / samples.length;
                    
                    this.log(`🎵 音频分析: 范围[${minValue.toFixed(3)}, ${maxValue.toFixed(3)}], 平均幅度: ${avgValue.toFixed(4)}`, 'info');

                    // 创建AudioBuffer
                    const buffer = this.audioContext.createBuffer(1, samples.length, sampleRate);
                    const channelData = buffer.getChannelData(0);
                    
                    // 应用音量并复制数据
                    for (let i = 0; i < samples.length; i++) {
                        channelData[i] = samples[i] * this.aiVolume;
                    }

                    // 立即播放，无需队列管理
                    this.playAudioBuffer(buffer);

                } catch (error) {
                    this.log(`❌ 流式音频处理失败: ${error.message}`, 'error');
                }
            }

            async playAudioBuffer(buffer) {
                // 直接播放AudioBuffer
                try {
                    const source = this.audioContext.createBufferSource();
                    source.buffer = buffer;
                    
                    // 根据设备选择确定目标
                    let destination = this.audioContext.destination;
                    
                    // 如果选择了特定扬声器设备，使用Audio元素播放
                    if (this.selectedSpeakerId && this.selectedSpeakerId !== 'default') {
                        // 确保mediaStreamDestination与当前audioContext匹配
                        if (!this.mediaStreamDestination || this.mediaStreamDestination.context !== this.audioContext) {
                            this.mediaStreamDestination = this.audioContext.createMediaStreamDestination();
                            
                            if (!this.audioElement) {
                                this.audioElement = new Audio();
                                this.audioElement.style.display = 'none';
                                document.body.appendChild(this.audioElement);
                            }
                            
                            this.audioElement.srcObject = this.mediaStreamDestination.stream;
                            try {
                                if (this.audioElement.setSinkId) {
                                    await this.audioElement.setSinkId(this.selectedSpeakerId);
                                    this.log(`🔊 已切换到指定扬声器设备`, 'info');
                                }
                                this.audioElement.play();
                            } catch (deviceError) {
                                this.log(`⚠️ 扬声器设备切换失败: ${deviceError.message}，使用默认设备`, 'warning');
                                destination = this.audioContext.destination;
                            }
                        }
                        
                        if (this.mediaStreamDestination && this.mediaStreamDestination.context === this.audioContext) {
                            destination = this.mediaStreamDestination;
                        }
                    }
                    
                    source.connect(destination);
                    
                    // 计算播放时间，实现连续播放
                    const currentTime = this.audioContext.currentTime;
                    const startTime = Math.max(currentTime, this.currentPlayTime);
                    
                    source.start(startTime);
                    this.currentPlayTime = startTime + buffer.duration;
                    
                    // 跟踪正在播放的音频源，用于语音打断
                    this.currentAudioSources.push(source);
                    
                    // 播放结束后从跟踪列表中移除
                    source.onended = () => {
                        const index = this.currentAudioSources.indexOf(source);
                        if (index > -1) {
                            this.currentAudioSources.splice(index, 1);
                        }
                    };
                    
                    this.log(`🎵 流式播放: ${buffer.duration.toFixed(3)}秒`, 'info');

                } catch (error) {
                    this.log(`❌ 播放缓冲区失败: ${error.message}`, 'error');
                }
            }

            interruptAIAudio() {
                // 实现语音打断功能：停止所有正在播放的AI音频
                try {
                    if (this.currentAudioSources.length > 0) {
                        this.log(`🛑 打断AI语音：停止 ${this.currentAudioSources.length} 个音频源`, 'warning');
                        
                        // 停止所有正在播放的音频源
                        this.currentAudioSources.forEach(source => {
                            try {
                                source.stop();
                            } catch (e) {
                                // 忽略已经停止的音频源
                            }
                        });
                        
                        // 清空音频源跟踪列表
                        this.currentAudioSources = [];
                        
                        // 重置播放时间，避免音频积压
                        this.currentPlayTime = this.audioContext ? this.audioContext.currentTime : 0;
                        
                        this.log('✅ AI音频已成功打断', 'success');
                    }
                } catch (error) {
                    this.log(`❌ 打断AI音频失败: ${error.message}`, 'error');
                }
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) {
                    alert('请输入消息内容');
                    return;
                }

                if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                    alert('请先连接服务器');
                    return;
                }

                // 按照官方文档发送三包ChatTTSText消息
                await this.sendChatTTSTextInThreePackets(message);
                this.addMessage('User', message);
                this.log(`📤 发送ChatTTSText消息(三包格式): ${message}`, 'info');
                messageInput.value = '';
            }

            async sendChatTTSTextInThreePackets(fullMessage) {
                try {
                    // 将消息分成两部分进行演示，实际使用中可以按需分割
                    const midPoint = Math.ceil(fullMessage.length / 2);
                    const firstPart = fullMessage.substring(0, midPoint);
                    const secondPart = fullMessage.substring(midPoint);

                    // 第一包：开始包
                    const firstPacket = {
                        type: 'chat_tts_text',
                        start: true,
                        end: false,
                        content: firstPart
                    };
                    this.websocket.send(JSON.stringify(firstPacket));
                    this.log(`📤 发送第一包: ${firstPacket}`, 'info');
                    
                    // 等待一下确保包的顺序
                    await new Promise(resolve => setTimeout(resolve, 10));

                    // 第二包：中间包（如果有第二部分内容）
                    if (secondPart) {
                        const middlePacket = {
                            type: 'chat_tts_text',
                            start: false,
                            end: false,
                            content: secondPart
                        };
                        this.websocket.send(JSON.stringify(middlePacket));
                        this.log(`📤 发送第二包: ${secondPart}`, 'info');
                        
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }

                    // 第三包：结束包
                    const endPacket = {
                        type: 'chat_tts_text',
                        start: false,
                        end: true,
                        content: ""
                    };
                    this.websocket.send(JSON.stringify(endPacket));
                    this.log(`📤 发送第三包: ${endPacket}`, 'info');

                } catch (error) {
                    this.log(`❌ 发送ChatTTSText失败: ${error.message}`, 'error');
                }
            }

            addMessage(sender, content, isAudio = false) {
                const conversationDisplay = document.getElementById('conversationDisplay');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender.toLowerCase()}`;
                
                const time = new Date().toLocaleTimeString();
                messageDiv.innerHTML = `
                    <div>${content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                conversationDisplay.appendChild(messageDiv);
                conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            }
        }

        // 全局实例
        let voiceChat;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            voiceChat = new VoiceChat();
        });

        // 向后兼容的全局函数
        function connect() { voiceChat.connect(); }
        function disconnect() { voiceChat.disconnect(); }
        function toggleConnection() { 
            if (voiceChat.isConnected) {
                voiceChat.disconnect();
            } else {
                voiceChat.connect();
            }
        }
        function toggleRecording() { voiceChat.toggleRecording(); }
        function sendMessage() { voiceChat.sendMessage(); }
        function clearLog() { voiceChat.clearLog(); }
        function copyLog() { voiceChat.copyLog(); }
        function toggleAutoScroll() { voiceChat.toggleAutoScroll(); }
        function refreshAudioDevices() { voiceChat.refreshAudioDevices(); }
        function testSpeaker() { voiceChat.testSpeaker(); }
    </script>
</body>
</html>